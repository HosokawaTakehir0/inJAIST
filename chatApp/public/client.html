<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ã¡ã‚ƒã£ã¨(group_d)</title>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="clientUtil.css">
</head>

<body style="overflow-x: hidden;">

    <h1>ã¡ã‚ƒã£ã¨</h1>

    <marquee scrollamount=10>
        <p id="entrant"></p>
    </marquee>

    <div style="position: relative;">
        <div id="board" style="height: 300px; width: 100%;
       overflow-y: scroll; border: 1px solid; overflow-x: hidden; position: relative;">
        </div>

        <div id="subBoard" style="height: 300px; width: 50%;
    overflow-y: scroll; border: 1px solid; background-color: white;
     position: absolute; top: 0; right: 1em; display:none; 
     resize: horizontal; min-width: 15%; max-width: 85%">
        
            
                <div id="delSubBoardBtn" class="round_btn"></div>
        </div>

    </div>


    <p>
        ãƒ¦ãƒ¼ã‚¶å<input type="text" name="myName" id="myName">
        ç™ºè¨€<input type="text" name="comment" id="comment">
        è‰²<input type="color" name="color" id="color">
        <input type="button" name="writeChat" value="æ›¸ãè¾¼ã¿" id="writeChat">
        <br />
        <input type="button" value="é¡”æ–‡å­—" id="emotionBtn" name="emotionBtn">

        <span id="replyInfo" style="display: none;"></span>
        <input type="button" value="è¿”ä¿¡å–ã‚Šæ¶ˆã—" id="noReply" style="display: none;" />

        <span id="emotionList" style="height: 100px; width: 14em; position: absolute;
        overflow-y:scroll; border: 1px solid; background-color: white;display:none;
         word-break: break-all; font-size: 25px; line-height: 0px"></span>

    </p>

    <script>

        const socket = io();
        const myID = Math.random();

        let myNameHtml = document.getElementById("myName");
        let commentHtml = document.getElementById("comment");
        let colorHtml = document.getElementById("color");
        let writeChatHtml = document.getElementById("writeChat");
        let boardHtml = document.getElementById("board");
        let entrantHtml = document.getElementById("entrant");
        let emotionBtnHtml = document.getElementById("emotionBtn");
        let emotionListHtml = document.getElementById("emotionList");
        let replyInfoHtml = document.getElementById("replyInfo");
        let noReplyHtml = document.getElementById("noReply");


        //é¡”æ–‡å­—ç”¨
        let emotionOffset = 0x1F600; //\u{1F600}=ğŸ˜€
        let emotionNum = 80;


        //ãƒãƒ£ãƒƒãƒˆæœ¬ä½“ç”¨
        let chats = [];
        boardHtml.innerHTML = "";

        //æŠ•ç¥¨ç®¡ç†ç”¨
        let positions = [];
        const voteMap = ["", "good", "bad"];


        //button.onclick -> div.onclick é †ã®å‡¦ç†ãªã®ã§ä½™è¨ˆãªã“ã¨ã‚’ã•ã›ãªã„ãŸã‚ã®ãƒ•ãƒ©ã‚°
        let isClickBtn = false;

        //å‚åŠ è€…æ•°æ ¼ç´
        let cntClient = 0;

        //ãƒãƒ£ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿
        //let ID;
        let myName;
        let comment;
        let color;
        let toUserName;
        let toUserID = 1;


        //æ›¸ãè¾¼ã¿å®Ÿè¡Œ
        writeChatHtml.onclick = function writeChatExe() {
            myName = myNameHtml.value;
            comment = commentHtml.value;
            color = colorHtml.value;
            //toUserName, toUserID ã¯è¿”ä¿¡ã™ã‚‹ã¨ãã®ã¿ã‚»ãƒƒãƒˆ
            if (comment == "") {
                alert("ç™ºè¨€ã‚’æ›¸ã„ã¦ä¸‹ã•ã„");
                return;
            }
            socket.emit("addChat",
                {
                    myName: myName,
                    comment: comment,
                    ID: myID,
                    color: color,
                    toUserName: toUserName,
                    toUserID: toUserID
                });
            commentHtml.value = "";
            toUserID = 1;
            toUserName = "";
            replyInfoHtml.style["display"] = "none";
            noReplyHtml.style["display"] = "none";
        }


        //è‡ªåˆ†ã«å‘ã‘ã‚‰ã‚ŒãŸãƒãƒ£ãƒƒãƒˆã€ã‚ã‚‹ã„ã¯è‡ªåˆ†ã®ãƒãƒ£ãƒƒãƒˆã‹å¦ã‹ã‚’åˆ¤å®š(userNameå‚ç…§)
        function isValidChat(data) {
            return (data.toUserID == 1 || data.toUserID == myID||
                data.ID == myID)
        }

        //ãƒãƒ£ãƒƒãƒˆå—ã‘å–ã‚Š
        socket.on("recieveChat", function (data) {
            chats.push(data);
            positions.push(0);
            let newDiv;
            newDiv = makeChatDiv(data);
            if (isValidChat(data)) newDiv = makeChatDiv(data);
            else return;
            boardHtml.appendChild(newDiv);
            boardHtml.scrollTop = boardHtml.scrollHeight;
        });

        //ãƒãƒ£ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã®indexã‹ã‚‰boardå†…ã®indexã«å¤‰æ›
        function chatNumToBoardIndex(chatNum) {
            let tmp = boardHtml.childElementCount - 1;
            for (let i = chatNum < tmp ? chatNum : tmp; i >= 0; --i) {
                if (boardHtml.children[i].chatNum == chatNum) {
                    return i;
                }
            }
            return -1;
        }


        //è‡ªåˆ†ã®ãƒãƒ£ãƒƒãƒˆã‚’å‰Šé™¤ä¾é ¼
        function delMyChat() {
            isClickBtn = true;
            socket.emit("delServerChat", this.parentNode.chatNum);
        }
        //ãƒãƒ£ãƒƒãƒˆã®å‰Šé™¤
        socket.on("delChat", function (chatNum) {
            chats[chatNum].invalid = true;
            let boardInd = chatNumToBoardIndex(chatNum);
            let rmvTarget = boardHtml.children[boardInd];
            rmvTarget.style["--xParam"] = "-100%";
            rmvTarget.style["animation"] = "outAnime 0.5s forwards";
            rmvTarget.addEventListener("animationend", function () {
                boardHtml.removeChild(rmvTarget);
            });

        });


        //ãƒãƒ£ãƒƒãƒˆã«å¯¾ã™ã‚‹æŠ•ç¥¨
        function positionVote() {
            isClickBtn = true;
            let chatNum = this.parentNode.chatNum;
            let posit = this.name;
            if (positions[chatNum] == this.flag) {
                alert("æŠ•ç¥¨æ¸ˆã¿ã§ã™");
                return;
            }
            socket.emit("vote", {
                chatNum: chatNum,
                newPosit: this.flag,
                oldPosit: positions[chatNum]
            });
            positions[chatNum] = this.flag;
            for (let i = 1; i < voteMap.length; ++i) {
                let btn = this.parentNode.children[voteMap[i]];
                if (i == this.flag) btn.style.backgroundColor = "#aaaaaa";
                else btn.style.backgroundColor = "";

            }
        }
        //æŠ•ç¥¨çµæœã®æ›´æ–°
        socket.on("updateVote", function (data) {
            let boardInd = chatNumToBoardIndex(data[0]);
            let child = boardHtml.children[boardInd].children;
            for (let i = 1; i < voteMap.length; ++i) {
                let btn = child[voteMap[i]];
                btn.num = data[i];
                btn.textContent = btn.name + " : " + btn.num;
            }
        });


        //ãƒãƒ£ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã®æ–‡å­—åˆ—åŒ–
        function chatToStr(data) {
            let str = "<br/>";
            console.log(data["toUserID"], myID);
            if (data["toUserID"] == data["ID"]) str += "<b></b><b></b>è‡ªåˆ†è‡ªèº«ã¸ã®ã•ã•ã‚„ãã§ã™";
            else if (data["toUserID"] != 1) {
                str += ("<b>" + data["myName"] + "</b>ã‹ã‚‰<b>" + data["toUserName"] +
                    "</b>ã¸ã®ã•ã•ã‚„ãã§ã™");
            } else str += ("<b>" + data["myName"] + "</b><b></b>");

            str += ("   " + data["date"] + ":<br/>" + data["comment"]);
            return str;
        }
        //rgbã‚’ã‚«ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã«å¤‰æ›
        function rgbToHex(rgb) {
            rgb = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
            function toHexStr(c) {
                let hex = Number(c).toString(16);
                return hex.length == 1 ? "0" + hex : hex;
            }

            return "#" + toHexStr(rgb[1]) + toHexStr(rgb[2])
                + toHexStr(rgb[3]);
        }
        //ãƒãƒ£ãƒƒãƒˆã®æ–‡å­—è‰²å–å¾—
        function getChatColor() {
            if (isClickBtn) {
                isClickBtn = false;
                return;
            }
            let rgb = getComputedStyle(this).color;
            colorHtml.value = rgbToHex(rgb);
        }


        let subBoardHtml = document.getElementById("subBoard");
        //ã‚µãƒ–ãƒœãƒ¼ãƒ‰ã‚’éè¡¨ç¤º
        function subDisplayNone() {
            subBoardHtml.style["display"] = "none";
        }
        //ã‚µãƒ–ãƒœãƒ¼ãƒ‰ç”Ÿæˆ
        function createSubBoard() {
            if (isClickBtn) {
                isClickBtn = false;
                return;
            }
            let subBtnHtml = document.getElementById("delSubBoardBtn");
            let col = rgbToHex(getComputedStyle(this).color);
            subBoardHtml.style["display"] = "block";
            subBoardHtml.style["animation"] = "inAnime 0.5s forwards";
            subBtnHtml.style.backgroundColor = col;
            subBtnHtml.onclick = delSubBoardExe;
            subBoardHtml.removeEventListener("animationend", subDisplayNone);

            let tmpHtml = subBoardHtml.children[0];
            subBoardHtml.innerHTML = "";
            subBoardHtml.appendChild(tmpHtml);
            for (let i = 0; i < chats.length; ++i) {
                let newDiv = makeChatDiv(chats[i]);
                
                if (!chats[i].invalid && chats[i].color == col && isValidChat(chats[i]) ) {
                    while (newDiv.children[4]) {
                        newDiv.removeChild(newDiv.children[4]);
                    }
                    subBoardHtml.appendChild(newDiv);
                }
            }
        }
        //ã‚µãƒ–ãƒœãƒ¼ãƒ‰å‰Šé™¤
        function delSubBoardExe() {
            subBoardHtml.style["animation"] = "outAnime2 0.5s forwards";
            subBoardHtml.addEventListener("animationend", subDisplayNone);
        }


        //ãƒãƒ£ãƒƒãƒˆã®ç”Ÿæˆ
        function makeChatDiv(data) {
            let htmlObj = document.createElement("div");
            htmlObj.innerHTML = chatToStr(data);
            htmlObj.style.color = data.color;
            htmlObj.onclick = getChatColor;
            htmlObj.ondblclick = createSubBoard;
            htmlObj.chatNum = data.chatNum;
            htmlObj.className = "box";
            htmlObj.oncontextmenu = setReply;
            htmlObj.appendChild(document.createElement("div"));

            if (myNameHtml.value == data["myName"] &&
                data["ID"] == myID) {
                let delBtn = document.createElement("button");
                delBtn.textContent = "å‰Šé™¤";
                delBtn.name = "delButton";
                delBtn.onclick = delMyChat;
                htmlObj.appendChild(delBtn);
            }

            for (let i = 1; i < voteMap.length; ++i) {
                let btn = document.createElement("button");
                btn.name = voteMap[i];
                btn.num = data.posit[i];
                btn.textContent = voteMap[i] + " : " + String(data.posit[i]);
                btn.flag = i;
                btn.onclick = positionVote;
                htmlObj.appendChild(btn);
            }

            return htmlObj;
        }


        //æ•°å­—ã‹ã‚‰unicodeã‚’ç”Ÿæˆ
        function intToUnicode(num) {
            if (num < 0x10000) return String.fromCharCode(num);
            else {
                let cp = num - 0x10000;
                let high = 0xD800 | (cp >> 10);
                let low = 0xDC00 | (cp & 0x3FF);
                return String.fromCharCode(high, low);
            }
        }
        //çµµæ–‡å­—ãƒœã‚¿ãƒ³ç”Ÿæˆ
        for (let i = 0; i < emotionNum; ++i) {
            let x = intToUnicode(emotionOffset + i);
            let btn = document.createElement("button");
            btn.name = "emotion";
            btn.textContent = x;
            btn.onclick = setEmotion;
            btn.style["fontSize"] = "20px";
            btn.style["border"] = "1px solid gray";
            btn.style["backgroundColor"] = "white";
            emotionListHtml.appendChild(btn);
        }
        //çµµæ–‡å­—ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã¨ãã€çµµæ–‡å­—ãƒªã‚¹ãƒˆã‚’å‘¼ã³å‡ºã—
        emotionBtnHtml.onclick = function () {
            emotionListHtml.style["display"] = "block";
            let rect = emotionBtnHtml.getBoundingClientRect();
            emotionListHtml.style.left = rect.left + "px";
            emotionListHtml.style.top = rect.top + "px";
        }

        //ãƒã‚¦ã‚¹ãŒé›¢ã‚ŒãŸã‚‰éè¡¨ç¤º
        emotionListHtml.addEventListener("mouseleave", function () {
            emotionListHtml.style["display"] = "none";
        });
        //ãƒã‚¦ã‚¹ã®ä¹—ã£ã¦ã„ã‚‹å­è¦ç´ ã®èƒŒæ™¯è‰²ã‚’ä»˜ã‘ã‚‹
        emotionListHtml.addEventListener("mouseover", function (event) {
            event.target.style["backgroundColor"] = "PaleTurquoise";
        });
        //ãƒã‚¦ã‚¹ãŒå­è¦ç´ ã‹ã‚‰é›¢ã‚ŒãŸã‚‰èƒŒæ™¯è‰²ã‚’ç™½ã«æˆ»ã™
        emotionListHtml.addEventListener("mouseout", function () {
            event.target.style["backgroundColor"] = "white";
        });
        //æŠ¼ã•ã‚ŒãŸãƒœã‚¿ãƒ³ã®çµµæ–‡å­—ã‚’ç™ºè¨€ã«è¿½åŠ 
        function setEmotion() {
            commentHtml.value += this.textContent;
        }

        //è¿”ä¿¡å…ˆè¨­å®š
        function setReply() {
            let chatNum = this.chatNum;
            toUserName = chats[chatNum].myName;
            toUserID = chats[chatNum].ID;
            //if (toUserID == myID) return false;
            if (toUserID == myID) replyInfoHtml.innerHTML = "è‡ªåˆ†è‡ªèº«ã¸ã®ã•ã•ã‚„ãã§ã™";
            else replyInfoHtml.innerHTML = "<b>" + toUserName + "</b>ã•ã‚“ã«ã•ã•ã‚„ãã¾ã™";
            replyInfoHtml.style["display"] = "block";
            noReplyHtml.style["display"] = "block";
            return false;//å³ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚­ãƒ£ãƒ³ã‚»ãƒ«
        }
        //è¿”ä¿¡å…ˆå–ã‚Šæ¶ˆã—
        noReplyHtml.onclick = function () {
            replyInfoHtml.style["display"] = "none";
            noReplyHtml.style["display"] = "none";
            toUserID = 1;
            toUserName = "";
        }


        //å…¨ãƒãƒ£ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿æ›¸ãè¾¼ã¿
        function chatsWrite() {
            boardHtml.innerHTML = "";
            let cntDelChat = 0;
            positions = Array(chats.length);
            for (let i = 0; i < chats.length; ++i) {
                let newDiv = makeChatDiv(chats[i]);

                if (chats[i].invalid || !isValidChat(chats[i])) ++cntDelChat;
                else {
                    newDiv.style.animationDelay = String((i - cntDelChat) / 20) + "s";
                    boardHtml.appendChild(newDiv);
                }
                positions[i] = 0;
            }
            
        }

        //åˆæœŸãƒœãƒ¼ãƒ‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        let itv = 5;
        let y = 0;
        let dy = 4;
        function scrollPage() {
            boardHtml.scrollTo(0, y+= dy);
            if (y < boardHtml.scrollHeight) { setTimeout("scrollPage()", itv); }
            if (y >= boardHtml.scrollHeight) return;
        }
        scrollPage();


        //åˆæœŸèª­ã¿è¾¼ã¿
        socket.on("getInit", function (serverChats) {
            chats = serverChats;
            chatsWrite();
        });


        //å‚åŠ è€…æ•°å¢—æ¸›
        socket.on("updateCntClient", function (cnt) {
            cntClient = cnt;
            entrantHtml.innerHTML = "ç¾åœ¨" + String(cnt) + "äººãŒå‚åŠ ã—ã¦ã„ã¾ã™.";
        });


    </script>

</body>
</html>